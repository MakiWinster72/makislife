<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>七日键盘使用统计</title>
    <link rel="stylesheet" href="../assets/css/fonts.css" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --yellow: #f8c224;
        --cucumber: #88a860;
        --red: #cb392e;
        --sycamore: #a2903c;
        --cocoa: #282018;
        --light-bg: #fffef9;
        --gradient-main: linear-gradient(135deg, #cb392e 0%, #a2903c 100%);
        --gradient-accent: linear-gradient(135deg, #88a860 0%, #a2903c 100%);
      }

      body {
        font-family: "hm", "IBM Plex Sans", sans-serif;
        background: var(--light-bg);
        color: var(--cocoa);
        min-height: 100vh;
        overflow-x: hidden;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem 1.5rem;
      }

      .header {
        text-align: center;
        margin-bottom: 3rem;
        animation: fadeInDown 0.8s ease-out;
      }

      @keyframes fadeInDown {
        from {
          opacity: 0;
          transform: translateY(-30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .header h1 {
        font-family: "hm", serif;
        font-size: clamp(2rem, 5vw, 3.5rem);
        font-weight: 900;
        background: var(--gradient-main);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 0;
        letter-spacing: -0.02em;
        line-height: 1.2;
      }

      .loading {
        text-align: center;
        padding: 4rem 2rem;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 3px solid rgba(203, 57, 46, 0.2);
        border-top-color: var(--red);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1.5rem;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .summary {
        background: white;
        border-radius: 20px;
        padding: 2.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 12px rgba(40, 32, 24, 0.08);
        animation: fadeIn 0.8s ease-out;
      }

      .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
      }

      .summary-item {
        font-family: "hm";
        text-align: center;
      }

      .summary-label {
        font-size: 0.875rem;
        color: var(--sycamore);
        margin-bottom: 0.5rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .summary-value {
        font-size: clamp(2rem, 4vw, 2.8rem);
        font-weight: 700;
        font-family: "code", "JetBrains Mono", monospace;
        color: var(--red);
        line-height: 1.2;
      }

      .summary-subtitle {
        font-size: 0.875rem;
        color: var(--cocoa);
        margin-top: 0.25rem;
        opacity: 0.7;
      }

      .summary-text {
        text-align: center;
        font-size: 1.1rem;
        color: var(--cocoa);
        padding: 1.5rem;
        background: linear-gradient(
          135deg,
          rgba(136, 168, 96, 0.1),
          rgba(162, 144, 60, 0.1)
        );
        border-radius: 12px;
        border-left: 4px solid var(--cucumber);
      }

      .summary-text strong {
        color: var(--red);
        font-weight: 600;
      }

      .charts-container {
        display: grid;
        gap: 2rem;
        margin-bottom: 2rem;
      }

      .chart-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 2rem;
      }

      .chart-row-full {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
      }

      .chart-card {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 2px 12px rgba(40, 32, 24, 0.08);
        transition: all 0.3s ease;
      }

      .chart-card:hover {
        box-shadow: 0 2px 12px rgba(40, 32, 24, 0.08);
        transform: translateY(-2px);
      }

      .chart-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--cocoa);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-family: "code", sans-serif;
      }

      .chart-title::before {
        content: "";
        width: 4px;
        height: 20px;
        background: var(--gradient-main);
        border-radius: 2px;
      }

      .chart-wrapper {
        position: relative;
        height: 300px;
        width: 100%;
        max-width: 100%;
        overflow: visible;
        padding: 10px;
      }

      .chart-card:hover {
        box-shadow:
          0 12px 40px rgba(203, 57, 46, 0.2),
          0 4px 16px rgba(40, 32, 24, 0.12);
        transform: translateY(-4px);
      }

      .chart-wrapper canvas {
        max-width: 100% !important;
        height: auto !important;
      }

      .chart-subtitle {
        font-size: 0.95rem;
        color: var(--sycamore);
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
        font-weight: 500;
      }

      .footer {
        text-align: center;
        padding: 2rem 1rem;
        color: var(--sycamore);
        font-size: 0.875rem;
        border-top: 1px solid rgba(40, 32, 24, 0.1);
        margin-top: 3rem;
      }

      .footer-info {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
        margin-top: 0.75rem;
      }

      .footer-divider {
        color: var(--sycamore);
        opacity: 0.5;
      }

      /* Animations */
      .fade-in {
        animation: fadeIn 0.8s ease-out backwards;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .fade-in:nth-child(1) {
        animation-delay: 0.1s;
      }
      .fade-in:nth-child(2) {
        animation-delay: 0.2s;
      }
      .fade-in:nth-child(3) {
        animation-delay: 0.3s;
      }
      .fade-in:nth-child(4) {
        animation-delay: 0.4s;
      }

      @media (max-width: 768px) {
        .container {
          padding: 1.5rem 1rem;
        }

        .header {
          margin-bottom: 2rem;
        }

        .summary {
          padding: 1.5rem;
        }

        .summary-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 1.5rem;
        }

        .summary-value {
          font-size: 1.75rem;
        }

        .summary-label {
          font-size: 0.75rem;
        }

        .summary-text {
          font-size: 1rem;
          padding: 1.25rem;
          text-align: left;
        }

        .chart-row,
        .chart-row-full {
          grid-template-columns: 1fr;
          gap: 1.5rem;
        }

        .chart-card {
          padding: 1.5rem;
          overflow: visible;
        }

        .chart-wrapper {
          height: 250px;
          max-width: 100%;
          overflow: visible;
          padding: 8px;
        }

        .chart-wrapper canvas {
          max-width: 100% !important;
          width: 100% !important;
        }

        .chart-title {
          font-size: 1.1rem;
        }

        .footer {
          padding: 1.5rem 0.5rem;
        }

        .footer-info {
          flex-direction: column;
          gap: 0.5rem;
        }

        .footer-divider {
          display: none;
        }

        .footer-timezone {
          display: none;
        }
      }

      @media (max-width: 480px) {
        .chart-wrapper {
          height: 220px;
        }
      }

      .error {
        text-align: center;
        padding: 3rem 2rem;
        background: white;
        border-radius: 20px;
        box-shadow: 0 2px 12px rgba(40, 32, 24, 0.08);
      }

      .error h2 {
        color: var(--red);
        margin-bottom: 1rem;
      }

      .error p {
        color: var(--cocoa);
        opacity: 0.7;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>七日代码使用统计</h1>
      </div>

      <div id="content">
        <div class="loading">
          <div class="spinner"></div>
          <p style="color: var(--sycamore)">正在加载数据...</p>
        </div>
      </div>
    </div>

    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script>
      if (typeof Chart === "undefined") {
        document.write(
          '<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"><\/script>',
        );
      }
    </script>
    <script>
      const JSON_FILE_PATH = "./wakatime.json";

      let charts = {};

      async function fetchWakaTimeData() {
        try {
          const response = await fetch(JSON_FILE_PATH);
          if (!response.ok) {
            throw new Error(`无法加载JSON文件: ${response.status}`);
          }
          const result = await response.json();
          // 如果JSON文件包含data字段，则使用data，否则直接使用结果
          return result.data || result;
        } catch (error) {
          console.error("Error fetching data:", error);
          throw new Error(
            "无法加载本地数据文件，请确保 wakatime.json 文件存在",
          );
        }
      }

      function formatTime(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        if (hours > 0) {
          return `${hours}小时${minutes}分钟`;
        }
        return `${minutes}分钟`;
      }

      function createSummary(data) {
        // 格式化最佳日期
        const bestDate = new Date(data.best_day.date);
        const month = bestDate.getMonth() + 1;
        const day = bestDate.getDate();

        // 解析时间
        const bestDayText = data.best_day.text;

        return `
                <div class="summary fade-in">
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">七日总码时</div>
                            <div class="summary-value">${data.human_readable_total.replace(" hrs", "时").replace(" mins", "分").replace("hr", "时").replace("min", "分")}</div>
                        </div>
                        
                        <div class="summary-item">
                            <div class="summary-label">日均</div>
                            <div class="summary-value">${data.human_readable_daily_average.replace(" hrs", "时").replace(" mins", "分").replace("hr", "时").replace("min", "分")}</div>
                            <div class="summary-subtitle">${data.days_minus_holidays}个工作日</div>
                        </div>
                    </div>
                    
                    <div class="summary-text">
                        七天内共有<strong>${data.days_minus_holidays}</strong>天在写代码,一共使用过<strong>${data.languages.length}</strong>种语言。其中时间最长的一天是<strong>${month}月${day}日</strong>,总共写了整整<strong>${bestDayText.replace(" hrs", "时").replace(" mins", "分").replace("hr", "时").replace("min", "分")}</strong>！！
                    </div>
                </div>
            `;
      }

      function createCharts(data) {
        return `
                <div class="charts-container">
                    <!-- 第一行：语言分布、操作系统 -->
                    <div class="chart-row fade-in">
                        <div class="chart-card">
                            <div class="chart-title">语言分布</div>
                            <div class="chart-wrapper">
                                <canvas id="languageChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-card">
                            <div class="chart-title">操作系统</div>
                            <div class="chart-wrapper">
                                <canvas id="osChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 第二行：主机、编辑器 -->
                    <div class="chart-row fade-in">
                        <div class="chart-card">
                            <div class="chart-title">主机分布</div>
                            <div class="chart-wrapper">
                                <canvas id="machineChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-card">
                            <div class="chart-title">编辑器</div>
                            <div class="chart-wrapper">
                                <canvas id="editorChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 第三行：项目分布 -->
                    <div class="chart-row-full fade-in">
                        <div class="chart-card">
                            <div class="chart-title">项目分布</div>
                            <div class="chart-wrapper">
                                <canvas id="projectChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 第四行：网站访问统计 -->
                    <div class="chart-row-full fade-in">
                        <div class="chart-card">
                            <div class="chart-title">网站访问统计</div>
                            <div class="chart-wrapper">
                                <canvas id="websiteChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            `;
      }

      function initializeCharts(data) {
        if (typeof Chart === "undefined") {
          console.error("Chart.js not loaded");
          return;
        }

        const colors = [
          "rgba(203, 57, 46, 0.8)",
          "rgba(136, 168, 96, 0.8)",
          "rgba(162, 144, 60, 0.8)",
          "rgba(248, 194, 36, 0.8)",
          "rgba(203, 57, 46, 0.6)",
          "rgba(136, 168, 96, 0.6)",
          "rgba(162, 144, 60, 0.6)",
          "rgba(248, 194, 36, 0.6)",
        ];

        const commonOptions = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: "right",
              labels: {
                color: "#282018",
                font: {
                  size: 11,
                  family: "code",
                },
                padding: 12,
                usePointStyle: true,
                pointStyle: "circle",
              },
            },
            tooltip: {
              backgroundColor: "rgba(40, 32, 24, 0.95)",
              titleColor: "#F8C224",
              bodyColor: "#FFFEF9",
              padding: 12,
              cornerRadius: 8,
              titleFont: {
                size: 13,
                weight: "600",
              },
              bodyFont: {
                size: 12,
              },
              callbacks: {
                label: function (context) {
                  const label = context.label || "";
                  const value = context.parsed || context.parsed.y || 0;
                  const dataset = context.dataset;
                  const dataIndex = context.dataIndex;
                  let timeText = "";
                  let percent = 0;

                  // 饼图/甜甜圈图
                  if (
                    context.chart.config.type === "doughnut" ||
                    context.chart.config.type === "pie"
                  ) {
                    // 根据图表ID获取对应数据
                    if (
                      context.chart.canvas.id === "languageChart" &&
                      data.languages[dataIndex]
                    ) {
                      timeText = data.languages[dataIndex].text;
                      percent = data.languages[dataIndex].percent;
                    } else if (
                      context.chart.canvas.id === "osChart" &&
                      data.operating_systems[dataIndex]
                    ) {
                      timeText = data.operating_systems[dataIndex].text;
                      percent = data.operating_systems[dataIndex].percent;
                    } else if (
                      context.chart.canvas.id === "machineChart" &&
                      data.machines[dataIndex]
                    ) {
                      timeText = data.machines[dataIndex].text;
                      percent = data.machines[dataIndex].percent;
                    }

                    return `${label}: ${timeText} (${percent.toFixed(1)}%)`;
                  }

                  // 对于柱状图
                  if (
                    context.chart.canvas.id === "projectChart" &&
                    data.projects[dataIndex]
                  ) {
                    timeText = data.projects[dataIndex].text;
                    percent = data.projects[dataIndex].percent;
                    return `${label}: ${timeText} (${percent.toFixed(1)}%)`;
                  }

                  if (
                    context.chart.canvas.id === "editorChart" &&
                    data.editors[dataIndex]
                  ) {
                    timeText = data.editors[dataIndex].text;
                    percent = data.editors[dataIndex].percent;
                    return `${label}: ${timeText} (${percent.toFixed(1)}%)`;
                  }

                  if (
                    context.chart.canvas.id === "machineChart" &&
                    data.machines[dataIndex]
                  ) {
                    timeText = data.machines[dataIndex].text;
                    percent = data.machines[dataIndex].percent;
                    return `${label}: ${timeText} (${percent.toFixed(1)}%)`;
                  }

                  if (
                    context.chart.canvas.id === "osChart" &&
                    data.operating_systems[dataIndex]
                  ) {
                    timeText = data.operating_systems[dataIndex].text;
                    percent = data.operating_systems[dataIndex].percent;
                    return `${label}: ${timeText} (${percent.toFixed(1)}%)`;
                  }

                  return `${label}: ${value.toFixed(1)}小时`;
                },
              },
            },
          },
        };

        // Language Chart - 甜甜圈图
        if (data.languages && data.languages.length > 0) {
          const ctx = document.getElementById("languageChart");
          if (ctx) {
            charts.language = new Chart(ctx, {
              type: "doughnut",
              data: {
                labels: data.languages.slice(0, 8).map((l) => l.name),
                datasets: [
                  {
                    data: data.languages.slice(0, 8).map((l) => l.percent),
                    backgroundColor: colors,
                    borderWidth: 0,
                  },
                ],
              },
              options: {
                ...commonOptions,
                cutout: "65%",
              },
            });
          }
        }

        // OS Chart - 横向柱状图
        if (data.operating_systems && data.operating_systems.length > 0) {
          const ctx = document.getElementById("osChart");
          if (ctx) {
            charts.os = new Chart(ctx, {
              type: "bar",
              data: {
                labels: data.operating_systems.map((os) => os.name),
                datasets: [
                  {
                    data: data.operating_systems.map((os) => os.decimal),
                    backgroundColor: "rgba(162, 144, 60, 0.7)",
                    borderWidth: 0,
                    borderRadius: 8,
                    hoverBackgroundColor: "rgba(162, 144, 60, 0.9)",
                  },
                ],
              },
              options: {
                ...commonOptions,
                indexAxis: "y",
                plugins: {
                  ...commonOptions.plugins,
                  legend: { display: false },
                },
                scales: {
                  x: {
                    beginAtZero: true,
                    grid: {
                      color: "rgba(40, 32, 24, 0.05)",
                    },
                    ticks: {
                      color: "#A2903C",
                      font: { size: 11, family: "code" },
                    },
                  },
                  y: {
                    grid: { display: false },
                    ticks: {
                      color: "#A2903C",
                      font: { size: 11, family: "code" },
                    },
                  },
                },
              },
            });
          }
        }

        // Machine Chart - 横向柱状图
        if (data.machines && data.machines.length > 0) {
          const ctx = document.getElementById("machineChart");
          if (ctx) {
            charts.machine = new Chart(ctx, {
              type: "bar",
              data: {
                labels: data.machines.map((m) => m.name),
                datasets: [
                  {
                    data: data.machines.map((m) => m.decimal),
                    backgroundColor: "rgba(136, 168, 96, 0.7)",
                    borderWidth: 0,
                    borderRadius: 8,
                    hoverBackgroundColor: "rgba(136, 168, 96, 0.9)",
                  },
                ],
              },
              options: {
                ...commonOptions,
                indexAxis: "y",
                plugins: {
                  ...commonOptions.plugins,
                  legend: { display: false },
                },
                scales: {
                  x: {
                    beginAtZero: true,
                    grid: {
                      color: "rgba(40, 32, 24, 0.05)",
                    },
                    ticks: {
                      color: "#A2903C",
                      font: { size: 11, family: "code" },
                    },
                  },
                  y: {
                    grid: { display: false },
                    ticks: {
                      color: "#A2903C",
                      font: { size: 11, family: "code" },
                    },
                  },
                },
              },
            });
          }
        }

        // Editor Chart - 横向柱状图（带图标）
        if (data.editors && data.editors.length > 0) {
          const ctx = document.getElementById("editorChart");
          if (ctx) {
            // 编辑器图标映射
            const getEditorIcon = (editorName) => {
              const name = editorName.toLowerCase();
              const iconMap = {
                obsidian:
                  "https://obsidian.md/images/obsidian-logo-gradient.svg",
                neovim: "https://img.makis-life.cn/icon/neovim.svg",
                vim: "https://img.makis-life.cn/icon/neovim.svg",
                "vs code":
                  "https://code.visualstudio.com/assets/branding/code-stable.png",
                firefox: "https://img.makis-life.cn/icon/zen-browser.svg",
              };
              return iconMap[name] || null;
            };

            // 使用代理服务器加载图标
            const loadIconWithProxy = (url) => {
              // 对于某些可能有跨域限制的URL，使用代理
              if (
                url.includes("code.visualstudio.com") ||
                url.includes("makis-life.cn")
              ) {
                return "https://corsproxy.io/?" + encodeURIComponent(url);
              }
              return url;
            };

            // 预加载所有图标
            const iconPromises = data.editors.map((editor) => {
              return new Promise((resolve) => {
                const iconUrl = getEditorIcon(editor.name);
                if (iconUrl) {
                  const img = new Image();
                  const proxiedUrl = loadIconWithProxy(iconUrl);

                  img.onload = () => {
                    console.log(`Icon loaded successfully: ${editor.name}`);
                    resolve({ name: editor.name, img: img, loaded: true });
                  };
                  img.onerror = (e) => {
                    console.error(
                      `Failed to load icon for ${editor.name}: ${proxiedUrl}`,
                      e,
                    );
                    // 尝试不使用代理再加载一次
                    const img2 = new Image();
                    img2.onload = () => {
                      console.log(
                        `Icon loaded successfully (without proxy): ${editor.name}`,
                      );
                      resolve({ name: editor.name, img: img2, loaded: true });
                    };
                    img2.onerror = () => {
                      console.error(
                        `Failed to load icon (retry): ${editor.name}`,
                      );
                      resolve({ name: editor.name, img: null, loaded: false });
                    };
                    img2.src = iconUrl;
                  };
                  img.src = proxiedUrl;
                } else {
                  resolve({ name: editor.name, img: null, loaded: false });
                }
              });
            });

            Promise.all(iconPromises).then((loadedIcons) => {
              const iconMap = {};
              loadedIcons.forEach((item) => {
                iconMap[item.name] = item.img;
                if (item.loaded) {
                  console.log(`Icon ready for chart: ${item.name}`);
                }
              });

              charts.editor = new Chart(ctx, {
                type: "bar",
                data: {
                  labels: data.editors.map((e) => e.name),
                  datasets: [
                    {
                      label: "小时",
                      data: data.editors.map((e) => e.decimal),
                      backgroundColor: "rgba(136, 168, 96, 0.7)",
                      borderColor: "rgba(136, 168, 96, 1)",
                      borderWidth: 0,
                      borderRadius: 8,
                      hoverBackgroundColor: "rgba(136, 168, 96, 0.9)",
                    },
                  ],
                },
                options: {
                  ...commonOptions,
                  indexAxis: "y",
                  layout: {
                    padding: {
                      left: 30, // 为图标留出空间
                    },
                  },
                  plugins: {
                    ...commonOptions.plugins,
                    legend: {
                      display: false,
                    },
                  },
                  scales: {
                    x: {
                      beginAtZero: true,
                      grid: {
                        color: "rgba(40, 32, 24, 0.05)",
                      },
                      ticks: {
                        color: "#A2903C",
                        font: {
                          size: 11,
                          family: "code",
                        },
                      },
                    },
                    y: {
                      grid: {
                        display: false,
                      },
                      ticks: {
                        color: "#A2903C",
                        font: {
                          size: 11,
                          family: "code",
                        },
                        padding: 5,
                      },
                    },
                  },
                },
                plugins: [
                  {
                    id: "customEditorIcons",
                    afterDatasetsDraw: function (chart) {
                      const ctx = chart.ctx;
                      const yScale = chart.scales.y;

                      chart.data.labels.forEach((label, index) => {
                        const icon = iconMap[label];
                        if (icon && icon.complete && icon.naturalWidth > 0) {
                          const y = yScale.getPixelForValue(index);
                          const iconSize = 18;
                          // 将图标绘制在标签文字前面
                          const x = yScale.left - iconSize - 8;

                          try {
                            ctx.save();
                            ctx.drawImage(
                              icon,
                              x,
                              y - iconSize / 2,
                              iconSize,
                              iconSize,
                            );
                            ctx.restore();
                          } catch (e) {
                            console.error(
                              "Error drawing icon for",
                              label,
                              ":",
                              e,
                            );
                          }
                        } else {
                          if (icon) {
                            console.warn(`Icon not ready for ${label}:`, {
                              complete: icon.complete,
                              naturalWidth: icon.naturalWidth,
                              src: icon.src,
                            });
                          }
                        }
                      });
                    },
                  },
                ],
              });
            });
          }
        }

        // Project Chart - 柱状图
        if (data.projects && data.projects.length > 0) {
          const ctx = document.getElementById("projectChart");
          if (ctx) {
            const projectCount = 15;

            charts.project = new Chart(ctx, {
              type: "bar",
              data: {
                labels: data.projects.slice(0, projectCount).map((p) => p.name),
                datasets: [
                  {
                    label: "小时",
                    data: data.projects
                      .slice(0, projectCount)
                      .map((p) => p.decimal),
                    backgroundColor: "rgba(203, 57, 46, 0.7)",
                    borderColor: "rgba(203, 57, 46, 1)",
                    borderWidth: 0,
                    borderRadius: 8,
                    hoverBackgroundColor: "rgba(203, 57, 46, 0.95)",
                    hoverBorderWidth: 2,
                    hoverBorderColor: "#CB392E",
                  },
                ],
              },
              options: {
                ...commonOptions,
                plugins: {
                  ...commonOptions.plugins,
                  legend: {
                    display: false,
                  },
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    grid: {
                      color: "rgba(40, 32, 24, 0.05)",
                    },
                    ticks: {
                      color: "#A2903C",
                      font: {
                        size: 11,
                        family: "code",
                      },
                    },
                  },
                  x: {
                    grid: {
                      display: false,
                    },
                    ticks: {
                      color: "#A2903C",
                      font: {
                        size: 11,
                        family: "code",
                      },
                      maxRotation: 45,
                      minRotation: 45,
                    },
                  },
                },
                interaction: {
                  intersect: false,
                  mode: "index",
                },
              },
            });
          }
        }

        // Website Chart - 横向柱状图
        initializeWebsiteChart();
      }

      async function initializeWebsiteChart() {
        try {
          // 加载 zen.json 数据
          const response = await fetch("./zen.json");
          if (!response.ok) {
            console.warn("无法加载 zen.json 文件");
            return;
          }
          const zenData = await response.json();

          // 按 focus 时间排序
          zenData.sort((a, b) => b.focus - a.focus);

          // 根据屏幕宽度决定显示数量
          const isMobile = window.innerWidth <= 768;
          const displayCount = isMobile ? 6 : 15;
          const topWebsites = zenData.slice(0, displayCount);

          const ctx = document.getElementById("websiteChart");
          if (!ctx) return;

          // 获取 favicon 的函数
          const getFaviconUrl = (host) => {
            // 移除端口号
            const cleanHost = host.split(":")[0];

            // 对于 localhost 和 IP 地址，使用默认图标
            if (cleanHost === "127.0.0.1" || cleanHost === "localhost") {
              return `data:image/svg+xml,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23A2903C"><circle cx="12" cy="12" r="10"/></svg>')}`;
            }

            // 使用 Google 的 favicon 服务
            return `https://www.google.com/s2/favicons?domain=${cleanHost}&sz=32`;
          };

          // 预加载所有 favicon
          const faviconPromises = topWebsites.map((site) => {
            return new Promise((resolve) => {
              const img = new Image();
              const faviconUrl = getFaviconUrl(site.host);

              img.onload = () => {
                resolve({ host: site.host, img: img, loaded: true });
              };
              img.onerror = () => {
                // 如果加载失败，使用默认图标
                const defaultImg = new Image();
                const defaultIcon = `data:image/svg+xml,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23A2903C"><circle cx="12" cy="12" r="10"/></svg>')}`;
                defaultImg.src = defaultIcon;
                resolve({ host: site.host, img: defaultImg, loaded: true });
              };
              img.src = faviconUrl;
            });
          });

          Promise.all(faviconPromises).then((loadedFavicons) => {
            const faviconMap = {};
            loadedFavicons.forEach((item) => {
              faviconMap[item.host] = item.img;
            });

            // 格式化时间（秒转分钟）
            const formatFocusTime = (seconds) => {
              const minutes = Math.floor(seconds / 60);
              if (minutes >= 60) {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
              }
              return `${minutes}m`;
            };

            charts.website = new Chart(ctx, {
              type: "bar",
              data: {
                labels: topWebsites.map((site) => site.host),
                datasets: [
                  {
                    label: "时间",
                    data: topWebsites.map((site) => site.focus / 60), // 转换为分钟
                    backgroundColor: "rgba(248, 194, 36, 0.7)",
                    borderWidth: 0,
                    borderRadius: 8,
                    hoverBackgroundColor: "rgba(248, 194, 36, 0.9)",
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: "y",
                layout: {
                  padding: {
                    left: 30, // 为 favicon 留出空间
                  },
                },
                plugins: {
                  legend: {
                    display: false,
                  },
                  tooltip: {
                    backgroundColor: "rgba(40, 32, 24, 0.95)",
                    titleColor: "#F8C224",
                    bodyColor: "#FFFEF9",
                    padding: 12,
                    cornerRadius: 8,
                    titleFont: {
                      size: 13,
                      weight: "600",
                    },
                    bodyFont: {
                      size: 12,
                    },
                    callbacks: {
                      label: function (context) {
                        const dataIndex = context.dataIndex;
                        const site = topWebsites[dataIndex];
                        const focusTime = formatFocusTime(site.focus);
                        const visits = site.time;
                        return [`时间: ${focusTime}`, `访问次数: ${visits}次`];
                      },
                    },
                  },
                },
                scales: {
                  x: {
                    beginAtZero: true,
                    grid: {
                      color: "rgba(40, 32, 24, 0.05)",
                    },
                    ticks: {
                      color: "#A2903C",
                      font: {
                        size: 11,
                        family: "code",
                      },
                      callback: function (value) {
                        // 显示为分钟
                        return value >= 60
                          ? `${Math.floor(value / 60)}h`
                          : `${value}m`;
                      },
                    },
                    title: {
                      display: true,
                      text: "时间（分钟）",
                      color: "#A2903C",
                      font: {
                        size: 11,
                        family: "code",
                      },
                    },
                  },
                  y: {
                    grid: {
                      display: false,
                    },
                    ticks: {
                      color: "#A2903C",
                      font: {
                        size: 11,
                        family: "code",
                      },
                      padding: 5,
                    },
                  },
                },
              },
              plugins: [
                {
                  id: "customWebsiteFavicons",
                  afterDatasetsDraw: function (chart) {
                    const ctx = chart.ctx;
                    const yScale = chart.scales.y;

                    chart.data.labels.forEach((label, index) => {
                      const favicon = faviconMap[label];
                      if (
                        favicon &&
                        favicon.complete &&
                        favicon.naturalWidth > 0
                      ) {
                        const y = yScale.getPixelForValue(index);
                        const iconSize = 16;
                        const x = yScale.left - iconSize - 10;

                        try {
                          ctx.save();
                          // 绘制圆形背景
                          ctx.beginPath();
                          ctx.arc(
                            x + iconSize / 2,
                            y,
                            iconSize / 2 + 2,
                            0,
                            Math.PI * 2,
                          );
                          ctx.fillStyle = "rgba(255, 255, 255, 0.9)";
                          ctx.fill();
                          ctx.strokeStyle = "rgba(162, 144, 60, 0.2)";
                          ctx.lineWidth = 1;
                          ctx.stroke();

                          // 绘制 favicon
                          ctx.drawImage(
                            favicon,
                            x,
                            y - iconSize / 2,
                            iconSize,
                            iconSize,
                          );
                          ctx.restore();
                        } catch (e) {
                          console.error(
                            "Error drawing favicon for",
                            label,
                            ":",
                            e,
                          );
                        }
                      }
                    });
                  },
                },
              ],
            });
          });

          // 监听窗口大小变化，重新渲染图表
          let resizeTimer;
          window.addEventListener("resize", () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
              const newIsMobile = window.innerWidth <= 768;
              if (newIsMobile !== isMobile && charts.website) {
                charts.website.destroy();
                initializeWebsiteChart();
              }
            }, 250);
          });
        } catch (error) {
          console.error("加载网站统计数据失败:", error);
        }
      }

      function renderDashboard(data) {
        // 格式化日期范围
        const startDate = new Date(data.start);
        const endDate = new Date(data.end);
        const formatDate = (date) => {
          return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
        };

        let html = createSummary(data);
        html += createCharts(data);

        html += `
                <div class="footer">
                    <p>WakaTime 数据统计 ✅ 网费很贵！</p>
                    <div class="footer-info">
                        <span>${formatDate(startDate)} ~ ${formatDate(endDate)}</span>
                        <span class="footer-divider">•</span>
                        <span>更新：${new Date(data.modified_at).toLocaleString("zh-CN", { month: "long", day: "numeric", hour: "2-digit", minute: "2-digit" })}</span>
                        <span class="footer-divider footer-timezone">•</span>
                        <span class="footer-timezone">时区：${data.timezone}</span>
                    </div>
                </div>
            `;

        document.getElementById("content").innerHTML = html;

        setTimeout(() => {
          initializeCharts(data);
        }, 300);
      }

      function showError(message) {
        document.getElementById("content").innerHTML = `
                <div class="error">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">⚠️</div>
                    <h2>无法加载数据</h2>
                    <p style="margin-top: 1rem;">${message}</p>
                    <p style="margin-top: 0.5rem;">请检查 wakatime.json 文件是否存在</p>
                </div>
            `;
      }

      async function init() {
        let attempts = 0;
        const maxAttempts = 50;

        const waitForChart = () => {
          return new Promise((resolve) => {
            const check = () => {
              attempts++;
              if (typeof Chart !== "undefined") {
                console.log("Chart.js loaded successfully");
                resolve();
              } else if (attempts < maxAttempts) {
                setTimeout(check, 100);
              } else {
                console.error("Chart.js failed to load");
                resolve();
              }
            };
            check();
          });
        };

        await waitForChart();

        try {
          const data = await fetchWakaTimeData();
          renderDashboard(data);
        } catch (error) {
          showError(error.message);
        }
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
      } else {
        init();
      }
    </script>
  </body>
</html>
