<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾ˆæƒ³ä½ ï¼ï¼</title>
    <style>
        /* åŸºç¡€æ ·å¼ä¸CSSå˜é‡ */
        :root {
            --primary-bg: #fefefe;
            --secondary-bg: #f8f9fa;
            --sidebar-bg: #f5f6f7;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --accent-color: #f1c40f;
            --accent-hover: #f39c12;
            --highlight-bg: #fff3cd;
            --border-color: #e9ecef;
            --shadow-light: 0 2px 10px rgba(0,0,0,0.08);
            --shadow-medium: 0 4px 20px rgba(0,0,0,0.12);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-size: 1.3rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* ä¸»å¸ƒå±€å®¹å™¨ */
        .app-container {
            display: flex;
            height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
            background: var(--primary-bg);
            box-shadow: var(--shadow-medium);
        }

        /* é¡¶éƒ¨å¯¼èˆªï¼ˆä»…ç§»åŠ¨ç«¯æ˜¾ç¤ºï¼‰ */
        .top-nav {
            display: none;
            position: sticky;
            top: 0;
            z-index: 1100;
            background: var(--primary-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 0.6rem 1rem;
            gap: 0.5rem;
            align-items: center;
        }

        .top-nav-title {
            font-size: 1.1rem;
            color: var(--text-primary);
            font-weight: 600;
        }

        /* ä¾§è¾¹æ æ ·å¼ */
        .sidebar {
            width: 300px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            transform: translateX(0);
            transition: var(--transition);
            z-index: 1200;
        }

        .sidebar-header {
            padding: 2rem 1.5rem 1rem;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
        }

        .sidebar-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sidebar-subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .letters-list {
            padding: 1rem 0;
        }

        .letter-item {
            display: block;
            padding: 1rem 1.5rem;
            color: var(--text-primary);
            text-decoration: none;
            border-left: 3px solid transparent;
            transition: var(--transition);
            cursor: pointer;
            border-bottom: 1px solid rgba(233, 236, 239, 0.5);
        }

        .letter-item:hover {
            background: rgba(241, 196, 15, 0.1);
            border-left-color: var(--accent-color);
            transform: translateX(4px);
        }

        .letter-item.active {
            background: var(--highlight-bg);
            border-left-color: var(--accent-color);
            font-weight: 500;
        }

        .letter-title {
            font-size: 1.1rem;
            margin-bottom: 0.3rem;
        }

        .letter-preview {
            font-size: 0.85rem;
            color: var(--text-secondary);
            opacity: 0.8;
        }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .content-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--primary-bg);
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }

        .content-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .content-meta {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .content-body {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            background: var(--primary-bg);
        }

        /* Markdownæ¸²æŸ“æ ·å¼ */
        .markdown-content {
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.8;
        }

        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3 {
            margin: 2rem 0 1rem;
            color: var(--text-primary);
            font-weight: 600;
        }

        .markdown-content h1 {
            font-size: 2rem;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 0.5rem;
        }

        .markdown-content h2 {
            font-size: 1.5rem;
        }

        .markdown-content h3 {
            font-size: 1.2rem;
        }

        .markdown-content p {
            margin: 1rem 0;
            color: var(--text-primary);
        }

        .markdown-content blockquote {
            border-left: 4px solid var(--accent-color);
            padding-left: 1.5rem;
            margin: 1.5rem 0;
            font-style: italic;
            color: var(--text-secondary);
            background: rgba(241, 196, 15, 0.05);
            padding: 1rem 1.5rem;
            border-radius: 0 8px 8px 0;
        }

        .markdown-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: var(--shadow-light);
            margin: 1rem 0;
            cursor: pointer;
            transition: var(--transition);
        }

        .markdown-content img:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        /* é«˜äº®æ–‡æœ¬æ ·å¼ */
        .highlight {
            background: var(--highlight-bg);
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 500;
        }

        /* éŸ³ä¹æ’­æ”¾å™¨æ ·å¼ */
        .music-player {
            position: fixed;
            bottom: 2rem;
            left: 2rem;
            z-index: 2000;
        }

/* ç§»åŠ¨ç«¯æŒ‰é’®åªåœ¨å°å±å¹•æ˜¾ç¤º */
@media (max-width: 1024px) { /* å¯æ ¹æ®ä½ å¸ƒå±€è°ƒæ•´æ–­ç‚¹ */
    .top-nav { display: flex; }

    .mobile-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        position: static; /* æ”¾å…¥å¯¼èˆªå†…ï¼Œå–æ¶ˆå›ºå®šå®šä½ */
        z-index: 1001;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: var(--shadow-medium);
        transition: var(--transition);
        background: none;
        padding: 0;
    }

    .mobile-toggle:hover {
        transform: translateY(-2px) scale(1.05);
    }

    .mobile-toggle img {
        width: 60%;
        height: 60%;
        object-fit: contain;
        pointer-events: none;
    }
}

/* å¤§å±å¹•ï¼ˆç”µè„‘/å¹³æ¿ï¼‰éšè—æŒ‰é’® */
@media (min-width: 1025px) {
    .mobile-toggle {
        display: none;
    }
}



.music-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
}

.music-icon:hover {
    box-shadow: var(--shadow-medium-hover);
    transform: translateY(-2px) scale(1.05);
}

.music-icon img {
    max-width: 100%;     /* è‡ªé€‚åº”å®¹å™¨ */
    max-height: 100%;
    object-fit: contain;  /* ä¿æŒæ¯”ä¾‹ */
    pointer-events: none; /* é¿å…é˜»æ­¢ç‚¹å‡»äº‹ä»¶ */
}


/* åˆå§‹å°æ°”æ³¡ï¼ˆæ­Œæ›²åï¼‰ */
.music-bubble {
    position: absolute;
    bottom: 54px;
    left: 10px;
    max-width: 240px;
    padding: 8px 12px;
    border-radius: 10px;
    background: rgba(0,0,0,0.75);
    color: #fff;
    font-size: 12px;
    line-height: 1.4;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    box-shadow: var(--shadow-medium);
    transform: translateY(10px);
    opacity: 0;
    pointer-events: none;
    transition: var(--transition);
}

.music-bubble.active {
    transform: translateY(0);
    opacity: 1;
}

        .music-panel {
            position: absolute;
            bottom: 61px;
            left: 17px;
            background: var(--primary-bg);
            border-radius: 12px;
            padding: 1.5rem;
            min-width: 280px;
            box-shadow: var(--shadow-medium);
            border: 1px solid var(--border-color);
            transform: translateY(20px) scale(0.9);
            opacity: 0;
            pointer-events: none;
            transition: var(--transition);
        }

        .music-panel.active {
            transform: translateY(0) scale(1);
            opacity: 1;
            pointer-events: all;
        }

        .song-info {
            margin-bottom: 1rem;
        }

        .song-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .song-artist {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .audio-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .play-button {
            background: var(--accent-color);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .play-button:hover {
            background: var(--accent-hover);
            transform: scale(1.05);
        }

        .progress-container {
            flex: 1;
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
            overflow: hidden;
            cursor: pointer;
        }

        .progress-bar {
            height: 100%;
            background: var(--accent-color);
            width: 0%;
            transition: width 0.1s;
        }

        .mobile-overlay {
            display: none;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            transition: var(--transition);
        }

        .mobile-overlay.active {
            opacity: 1;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 992px) {
            /* å¹³æ¿è®¾å¤‡ */
            body {
                font-size: 1.3rem;
            }
            .sidebar-title {
                font-size: 1.4rem;
            }
            .content-title {
                font-size: 1.6rem;
            }
            .markdown-content h1 {
                font-size: 1.8rem;
            }
            .markdown-content h2 {
                font-size: 1.4rem;
            }
        }

        @media (max-width: 768px) {
            /* ç§»åŠ¨è®¾å¤‡ */
            body {
                font-size: 1.3rem;
            }
            .app-container {
                position: relative;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                transform: translateX(-100%);
                box-shadow: var(--shadow-medium);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .top-nav { display: flex; }

            .mobile-overlay {
                display: block;
            }

            .main-content {
                width: 100%;
            }
            
            .content-header {
                padding: 1.2rem 1.5rem;
            }

            .content-title {
                font-size: 1.4rem;
            }

            .content-body {
                padding: 1.5rem;
            }

            .music-player {
                bottom: 1rem;
                left: 1rem;
            }

            .music-panel {
                min-width: 250px;
            }
        }

        /* Lightboxæ ·å¼ */
        .lightbox {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 3000;
            cursor: pointer;
        }

        .lightbox.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lightbox img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            box-shadow: var(--shadow-medium);
        }

        .lightbox-controls {
            position: absolute;
            top: 2rem;
            right: 2rem;
            display: flex;
            gap: 1rem;
        }

        .lightbox-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
            transition: var(--transition);
        }

        .lightbox-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            color: var(--text-secondary);
        }

        .loading::after {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* æ— éšœç¢è®¿é—® */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        /* ç„¦ç‚¹æ ·å¼ */
        button:focus,
        .letter-item:focus {
            outline: 2px solid var(--accent-color);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªï¼ˆç§»åŠ¨ç«¯ï¼‰ -->
    <nav class="top-nav" role="navigation" aria-label="é¡¶éƒ¨å¯¼èˆª">
        <button class="mobile-toggle" aria-label="æ‰“å¼€èœå•" id="mobileToggle">
            <img src="https://img.makis-life.cn/icon/menu.png" alt="èœå•å›¾æ ‡">
        </button>
        <div class="top-nav-title" id="topNavTitle">æ€å¿µä¿¡</div>
    </nav>

    <!-- ç§»åŠ¨ç«¯é®ç½© -->
    <div class="mobile-overlay" id="mobileOverlay"></div>

    <div class="app-container">
        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1 class="sidebar-title">
                    æ€å¿µä¿¡
                </h1>
            </div>
            <nav class="letters-list" id="lettersList">
                <!-- ä¿¡ä»¶åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </nav>
        </aside>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <header class="content-header">
                <h2 class="content-title" id="contentTitle">åŠ è½½ä¸­...</h2>
                <div class="content-meta" id="contentMeta">è¯·ç¨å€™</div>
            </header>
            <div class="content-body">
                <div class="markdown-content" id="markdownContent">
                    <div class="loading">æ­£åœ¨åŠ è½½å†…å®¹...</div>
                </div>
            </div>
        </main>
    </div>

<!-- éŸ³ä¹æ’­æ”¾å™¨ï¼ˆå•æ–‡ä»¶ï¼‰ -->
<style>
/* å®¹å™¨ */
.music-player{

  font-family: system-ui, "Segoe UI", Roboto, "Noto Sans CJK SC", "Helvetica Neue", Arial;
  padding: 12px;

}


/* ä¿¡æ¯ + æ§ä»¶åŒº */

/* æ­Œå */
.song-info{
  padding: 6px 4px;
  margin-bottom:8px;
  text-align:left;
}
.song-title{
  font-weight:600;
  font-size:15px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.progress-container{
  flex:1;                 /* å æ»¡å‰©ä½™ç©ºé—´ */
  height:8px;
  border-radius:6px;
  background:linear-gradient(90deg,#f2f4f8,#f7f9fc);
  position:relative;
  cursor:pointer;
  overflow:hidden;
}
.progress-bar{ height:100%; width:0%; border-radius:6px; background:linear-gradient(90deg,#7db3ff,#5aa0ff); transition:width 0.12s linear; }

.audio-controls{
  display:flex;
  align-items:center;
  gap:10px;
  margin-top:6px;
}
.play-button{
  flex:0 0 44px; /* å›ºå®šå®½åº¦ */
  height:36px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  border-radius:8px;
  border:none;
  background:transparent;
  cursor:pointer;
  font-size:16px;
  padding:0 8px;
}
.play-button:active{ transform: scale(0.98); }

/* æ­Œå•ï¼šå»ç‚¹ã€åˆ†å‰²çº¿ã€æ— å‰å¯¼ç¬¦å· */
.playlist{
  list-style: none;
  padding: 3px 0 0 0;
  max-height:160px;
  overflow:auto;
}
.playlist li{
  padding:8px 6px;
  display:flex;
  align-items:center;
  gap:8px;
  cursor:pointer;
  user-select:none;
  font-size:14px;
  /* åˆ†å‰²çº¿ï¼ˆä¸‹è¾¹çº¿ï¼‰ï¼Œé¦–é¡¹ä»æœ‰ä¸‹çº¿ä½†è§†è§‰ä¸çªå…€ */
  border-bottom:1px solid rgba(0,0,0,0.06);
}
.playlist li:hover{ background: rgba(90,160,255,0.04); }
.playlist li.active{
  font-weight:700;
  background: linear-gradient(90deg, rgba(90,160,255,0.06), rgba(125,179,255,0.02));
}
</style>

<div class="music-player" role="region" aria-label="éŸ³ä¹æ’­æ”¾å™¨">
<div class="music-icon" id="musicIcon" tabindex="0" aria-hidden="true">
    <img src="https://img.makis-life.cn/icon/music1.png" alt="Music Icon">
</div>
<div class="music-bubble" id="musicBubble" aria-hidden="true"></div>


  <div class="music-panel" id="musicPanel">
 <div class="audio-controls">
    <button class="play-button" id="playButton" aria-label="æ’­æ”¾/æš‚åœï¼ˆ*Play/Pause*ï¼‰">â–¶ï¸</button>
    <div class="progress-container" id="progressContainer" title="ç‚¹å‡»è·³è½¬è¿›åº¦ï¼ˆ*click to seek*ï¼‰">
      <div class="progress-bar" id="progressBar"></div>
    </div>
  </div>

    <ul class="playlist" id="playlist" aria-label="æ’­æ”¾åˆ—è¡¨">
      <li data-index="0" class="active">å­—å­—å¥å¥</li>
      <li data-index="1">1000X</li>
      <li data-index="2">AI</li>
    </ul>
  </div>
</div>

<!-- éŸ³é¢‘å…ƒç´  -->
<audio id="audioPlayer" preload="metadata"></audio>

<script>
const playlist = [
  { title: "å­—å­—å¥å¥", src: "https://res.makis-life.cn/Music/å­—å­—å¥å¥-è‰¾è¾°.mp3" },
  { title: "1000X", src: "https://res.makis-life.cn/Music/1000X.mp3" },
  { title: "AI", src: "https://res.makis-life.cn/Music/AI-è–›ä¹‹è°¦.mp3" }
];

// æä¾›ç»™å…¨å±€ï¼ˆä¾›åç»­å°æ°”æ³¡è¯»å–æ­Œæ›²åï¼‰
window.playlist = playlist;

const audio = document.getElementById('audioPlayer');
const playBtn = document.getElementById('playButton');
const titleEl = document.getElementById('songTitle');
const progressBar = document.getElementById('progressBar');
const progressContainer = document.getElementById('progressContainer');
const playlistEl = document.getElementById('playlist');

let current = 0;
let isPlaying = false;

function loadTrack(index){
  current = index;
  audio.src = playlist[index].src;
  titleEl.textContent = playlist[index].title;
  // æ›´æ–°æ­Œå•é«˜äº®
  Array.from(playlistEl.children).forEach(li=>{
    li.classList.toggle('active', Number(li.dataset.index) === index);
  });
  audio.load();
}

function playPause(){
  if(!audio.src) loadTrack(current);
  if(audio.paused){
    audio.play();
  } else {
    audio.pause();
  }
}

// æ’­æ”¾/æš‚åœæŒ‰é’®
playBtn.addEventListener('click', ()=>{
  playPause();
});

// åŒæ­¥æŒ‰é’®å›¾æ ‡
audio.addEventListener('play', ()=>{
  isPlaying = true;
  playBtn.textContent = 'â¸ï¸';
  playBtn.setAttribute('aria-label','æš‚åœï¼ˆ*Pause*ï¼‰');
});
audio.addEventListener('pause', ()=>{
  isPlaying = false;
  playBtn.textContent = 'â–¶ï¸';
  playBtn.setAttribute('aria-label','æ’­æ”¾ï¼ˆ*Play*ï¼‰');
});

// æ›´æ–°è¿›åº¦æ¡
audio.addEventListener('timeupdate', ()=>{
  if(audio.duration){
    const pct = (audio.currentTime / audio.duration) * 100;
    progressBar.style.width = pct + '%';
  }
});

// ç‚¹å‡»è¿›åº¦æ¡è·³è½¬
progressContainer.addEventListener('click', (e)=>{
  const rect = progressContainer.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const pct = x / rect.width;
  if(audio.duration) audio.currentTime = pct * audio.duration;
});

// ç‚¹å‡»æ­Œå•åˆ‡æ­Œï¼ˆä¸ç”¨é¢å¤–åˆ‡æ¢æŒ‰é’®ï¼‰
playlistEl.addEventListener('click', (e)=>{
  const li = e.target.closest('li');
  if(!li) return;
  const idx = Number(li.dataset.index);
  if(idx === current){
    // åŒæ›²åˆ‡æ¢åˆ™åˆ‡æ¢æ’­æ”¾çŠ¶æ€
    playPause();
  } else {
    loadTrack(idx);
    audio.play();
  }
});

// æ’­æ”¾ç»“æŸè‡ªåŠ¨ä¸‹ä¸€é¦–ï¼ˆå¾ªç¯ï¼‰
audio.addEventListener('ended', ()=>{
  const next = (current + 1) % playlist.length;
  loadTrack(next);
  audio.play();
});

// åˆå§‹åŒ–
loadTrack(0);
</script>

    <!-- å›¾ç‰‡ç¯ç®± -->
    <div class="lightbox" id="lightbox">
        <div class="lightbox-controls">
            <button class="lightbox-btn" id="closeLightbox" aria-label="å…³é—­">âœ•</button>
        </div>
        <img id="lightboxImg" alt="æ”¾å¤§æŸ¥çœ‹">
    </div>

    <script>
        class LoveLettersApp {
            constructor() {
                this.currentLetter = 'letter3';
                this.letterCache = new Map();
                this.totalLetters = 4; // å¯æ ¹æ®å®é™…ä¿¡ä»¶æ•°é‡è°ƒæ•´sql
                this.isPlaying = false;
                this.showingSongTitle = false;
                
                this.initializeElements();
                this.setupEventListeners();
                this.generateLettersList();
                this.initializeFromHash();
                this.setupMusicPlayer();
            }

            initializeElements() {
                // DOMå…ƒç´ å¼•ç”¨
                this.elements = {
                    sidebar: document.getElementById('sidebar'),
                    lettersList: document.getElementById('lettersList'),
                    mobileToggle: document.getElementById('mobileToggle'),
                    mobileOverlay: document.getElementById('mobileOverlay'),
                    contentTitle: document.getElementById('contentTitle'),
                    contentMeta: document.getElementById('contentMeta'),
                    topNavTitle: document.getElementById('topNavTitle'),
                    markdownContent: document.getElementById('markdownContent'),
                    musicIcon: document.getElementById('musicIcon'),
                    musicPanel: document.getElementById('musicPanel'),
                    playButton: document.getElementById('playButton'),
                    progressContainer: document.getElementById('progressContainer'),
                    progressBar: document.getElementById('progressBar'),
                    audioPlayer: document.getElementById('audioPlayer'),
                    musicBubble: document.getElementById('musicBubble'),
                    lightbox: document.getElementById('lightbox'),
                    lightboxImg: document.getElementById('lightboxImg'),
                    closeLightbox: document.getElementById('closeLightbox')
                };
            }

            setupEventListeners() {
                // ç§»åŠ¨ç«¯èœå•åˆ‡æ¢
                this.elements.mobileToggle.addEventListener('click', () => {
                    this.toggleMobileSidebar();
                });

                this.elements.mobileOverlay.addEventListener('click', () => {
                    this.closeMobileSidebar();
                });

                // éŸ³ä¹æ’­æ”¾å™¨äº‹ä»¶
                this.elements.musicIcon.addEventListener('click', () => {
                    // ç‚¹å‡»å›¾æ ‡æ—¶å±•å¼€å®Œæ•´é¢æ¿
                    this.hideMusicBubble();
                    this.showMusicPanel();
                });

                this.elements.playButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.togglePlayback();
                });

                this.elements.progressContainer.addEventListener('click', (e) => {
                    this.seekAudio(e);
                });

                // éŸ³é¢‘æ’­æ”¾å™¨äº‹ä»¶
                this.elements.audioPlayer.addEventListener('timeupdate', () => {
                    this.updateProgress();
                });

                this.elements.audioPlayer.addEventListener('ended', () => {
                    this.resetPlayer();
                });

                this.elements.audioPlayer.addEventListener('loadedmetadata', () => {
                    this.showMusicBubble();
                });

                // å›¾ç‰‡ç¯ç®±äº‹ä»¶
                this.elements.lightbox.addEventListener('click', (e) => {
                    if (e.target === this.elements.lightbox) {
                        this.closeLightbox();
                    }
                });

                this.elements.closeLightbox.addEventListener('click', () => {
                    this.closeLightbox();
                });

                // é”®ç›˜äº‹ä»¶
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeLightbox();
                        this.closeMobileSidebar();
                        this.hideMusicPanel();
                    }
                });

                // URL hashå˜åŒ–ç›‘å¬
                window.addEventListener('hashchange', () => {
                    this.handleHashChange();
                });

                // ç‚¹å‡»é¡µé¢å…¶ä»–åŒºåŸŸéšè—éŸ³ä¹é¢æ¿ä¸ä¾§è¾¹æ ï¼ˆç§»åŠ¨ç«¯ï¼‰
                document.addEventListener('click', (e) => {
                    // éŸ³ä¹é¢æ¿
                    if (!this.elements.musicIcon.contains(e.target) && 
                        !this.elements.musicPanel.contains(e.target)) {
                        this.hideMusicPanel();
                    }

                    // ä¾§è¾¹æ ï¼ˆä»…åœ¨ç§»åŠ¨ç«¯å¹¶ä¸”ä¾§è¾¹æ å±•å¼€æ—¶ï¼‰
                    if (window.innerWidth <= 768 && this.elements.sidebar.classList.contains('active')) {
                        const clickedInsideSidebar = this.elements.sidebar.contains(e.target);
                        const clickedToggle = this.elements.mobileToggle && this.elements.mobileToggle.contains(e.target);
                        if (!clickedInsideSidebar && !clickedToggle) {
                            this.closeMobileSidebar();
                        }
                    }
                });
            }

            /**
             * ç”Ÿæˆä¿¡ä»¶åˆ—è¡¨
             * å¯ä»¥ä¿®æ”¹totalLetterså˜é‡æ¥è°ƒæ•´ä¿¡ä»¶æ•°é‡
             */
            generateLettersList() {
                const fragment = document.createDocumentFragment();
                
                for (let i = 1; i <= this.totalLetters; i++) {
                    const letterItem = document.createElement('a');
                    letterItem.className = 'letter-item';
                    letterItem.href = '#';
                    letterItem.dataset.letter = `letter${i}`;
                    letterItem.setAttribute('tabindex', '0');
                    letterItem.setAttribute('role', 'button');
                    letterItem.setAttribute('aria-label', `æŸ¥çœ‹ç¬¬${this.numberToChinese(i)}å°ä¿¡`);
                    
                    if (i === 3) {
                        letterItem.classList.add('active');
                    }
                    
                    letterItem.innerHTML = `
                        <div class="letter-title">ç¬¬${this.numberToChinese(i)}å°ä¿¡</div>
                    `;
                    
                    letterItem.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.selectLetter(letterItem, `letter${i}`);
                    });
                    
                    letterItem.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            this.selectLetter(letterItem, `letter${i}`);
                        }
                    });
                    
                    fragment.appendChild(letterItem);
                }
                
                this.elements.lettersList.appendChild(fragment);
            }

            /**
             * é€‰æ‹©ä¿¡ä»¶
             * @param {Element} letterItem - ä¿¡ä»¶é¡¹å…ƒç´ 
             * @param {string} letterId - ä¿¡ä»¶ID
             */
            selectLetter(letterItem, letterId) {
                // æ›´æ–°æ´»è·ƒçŠ¶æ€
                document.querySelectorAll('.letter-item').forEach(item => {
                    item.classList.remove('active');
                });
                letterItem.classList.add('active');
                
                // æ›´æ–°URL hash
                const letterNumber = letterId.replace('letter', '');
                window.location.hash = letterNumber;
                
                // åŠ è½½ä¿¡ä»¶å†…å®¹
                this.loadLetter(letterId);
                
                // ç§»åŠ¨ç«¯å…³é—­ä¾§è¾¹æ 
                if (window.innerWidth <= 768) {
                    this.closeMobileSidebar();
                }
            }

            /**
             * åŠ è½½ä¿¡ä»¶å†…å®¹
             * @param {string} letterId - ä¿¡ä»¶ID
             */
            async loadLetter(letterId) {
                this.currentLetter = letterId;
                const letterNumber = letterId.replace('letter', '');
                
                // æ›´æ–°æ ‡é¢˜å’Œå…ƒä¿¡æ¯
                this.elements.contentTitle.textContent = `ç¬¬${this.numberToChinese(parseInt(letterNumber))}å°ä¿¡`;
                this.elements.contentMeta.textContent = `ä¿¡ä»¶ç¼–å·ï¼š${letterId}`;
                // é¡¶éƒ¨å¯¼èˆªæ ‡é¢˜ä¿æŒå›ºå®šä¸ºâ€œæ€å¿µä¿¡â€ï¼Œä¸éšä¿¡ä»¶å˜åŒ–
                
                // æ£€æŸ¥ç¼“å­˜
                if (this.letterCache.has(letterId)) {
                    this.renderMarkdown(this.letterCache.get(letterId));
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                this.elements.markdownContent.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½å†…å®¹...</div>';
                
                try {
                    // å°è¯•åŠ è½½Markdownæ–‡ä»¶
                    const response = await fetch(`yao/${letterId}.md`);
                    
                    let content;
                    if (response.ok) {
                        content = await response.text();
                        this.letterCache.set(letterId, content);
                    } else {
                        // å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ˜¾ç¤ºç¤ºä¾‹å†…å®¹
                        content = this.getExampleContent(parseInt(letterNumber));
                        this.letterCache.set(letterId, content);
                    }
                    
                    this.renderMarkdown(content);
                    
                } catch (error) {
                    console.warn(`æ— æ³•åŠ è½½ ${letterId}.mdï¼Œæ˜¾ç¤ºç¤ºä¾‹å†…å®¹:`, error);
                    const content = this.getExampleContent(parseInt(letterNumber));
                    this.letterCache.set(letterId, content);
                    this.renderMarkdown(content);
                }
            }

            /**
             * è·å–ç¤ºä¾‹å†…å®¹ï¼ˆå½“å®é™…æ–‡ä»¶ä¸å­˜åœ¨æ—¶ä½¿ç”¨ï¼‰
             * @param {number} letterNumber - ä¿¡ä»¶ç¼–å·
             * @returns {string} Markdownå†…å®¹
             */
            getExampleContent(letterNumber) {
                const examples = [
                    `# è‡´ä½ çš„ç¬¬ä¸€å°ä¿¡

äº²çˆ±çš„ï¼Œ

è¿™æ˜¯æˆ‘å†™ç»™ä½ çš„ç¬¬ä¸€å°ä¿¡ã€‚åœ¨è¿™ä¸ªæ•°å­—åŒ–çš„æ—¶ä»£ï¼Œç”¨è¿™ç§æ–¹å¼è®°å½•æˆ‘ä»¬çš„æ•…äº‹ï¼Œä¼¼ä¹æ ¼å¤–æœ‰æ„ä¹‰ã€‚

==æ¯ä¸ªå­—éƒ½æ˜¯æˆ‘çš„å¿ƒæ„==ï¼Œæ¯å¥è¯éƒ½æ˜¯æˆ‘æƒ³å¯¹ä½ è¯´çš„è¯ã€‚

> æ—¶é—´ä¼šè¯æ˜ä¸€åˆ‡ï¼Œä½†æˆ‘ç°åœ¨å°±æƒ³å‘Šè¯‰ä½ ï¼Œä½ å¯¹æˆ‘æ¥è¯´æ„å‘³ç€ä»€ä¹ˆã€‚

æ„¿æˆ‘ä»¬çš„æ•…äº‹ï¼Œå¦‚è¿™äº›æ–‡å­—ä¸€æ ·ï¼Œæ°¸è¿œè¢«çè—ã€‚

çˆ±ä½ çš„äºº  
ğŸ’•`,

                    `# æƒ³å¿µçš„æ—¶åˆ»

ä»Šå¤©åˆæƒ³èµ·äº†ä½ ï¼Œ

==æƒ³å¿µçš„æ„Ÿè§‰åƒæ˜¥å¤©çš„é›¨==ï¼Œç»†ç»†å¯†å¯†ï¼Œè¯´ä¸æ¸…ä»ä»€ä¹ˆæ—¶å€™å¼€å§‹ï¼Œä¹Ÿä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™ä¼šç»“æŸã€‚

åªçŸ¥é“å½“è¿™ç§æ„Ÿè§‰æ¥ä¸´æ—¶ï¼Œæ•´ä¸ªä¸–ç•Œéƒ½å˜å¾—ä¸ä¸€æ ·äº†ã€‚

> æƒ³å¿µæ˜¯ä¸€ç§å¾ˆç„çš„ä¸œè¥¿ï¼Œå¦‚å½±éšå½¢ã€‚

å¸Œæœ›ä½ ä¹Ÿèƒ½æ„Ÿå—åˆ°è¿™ä»½æƒ³å¿µã€‚

â¤ï¸`,

                    `# å…³äºæ—¶é—´

æ—¶é—´è¿‡å¾—çœŸå¿«ï¼Œ

ä¼¼ä¹æ˜¨å¤©æˆ‘ä»¬è¿˜åœ¨åˆæ¬¡ç›¸é‡ï¼Œä»Šå¤©å´å·²ç»ç§¯ç´¯äº†è¿™ä¹ˆå¤šç¾å¥½çš„å›å¿†ã€‚

==æ—¶é—´è§è¯äº†æˆ‘ä»¬çš„æˆé•¿==ï¼Œä¹Ÿè§è¯äº†è¿™ä»½æ„Ÿæƒ…çš„æ·±åšã€‚

æ„Ÿè°¢æ—¶é—´ï¼Œè®©æˆ‘ä»¬ç›¸é‡ï¼›æ„Ÿè°¢æ—¶é—´ï¼Œè®©æˆ‘ä»¬å½¼æ­¤äº†è§£ï¼›æ›´æ„Ÿè°¢æ—¶é—´ï¼Œè®©æˆ‘ä»¬å­¦ä¼šçæƒœã€‚

ğŸ•â°`
                ];
                
                return examples[(letterNumber - 1) % examples.length];
            }

            /**
             * æ¸²æŸ“Markdownå†…å®¹
             * è¿™é‡Œä½¿ç”¨ç®€å•çš„Markdownè§£æï¼Œä½ å¯ä»¥æ›¿æ¢ä¸ºæ›´å¼ºå¤§çš„åº“å¦‚markedæˆ–markdown-it
             * @param {string} content - Markdownå†…å®¹
             */
            renderMarkdown(content) {
                let html = content
                    // æ ‡é¢˜
                    .replace(/^# (.+)$/gm, '<h1>$1</h1>')
                    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
                    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
                    // é«˜äº®æ–‡æœ¬
                    .replace(/==([^=]+)==/g, '<span class="highlight">$1</span>')
                    // ç²—ä½“
                    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                    // æ–œä½“
                    .replace(/\*([^*]+)\*/g, '<em>$1</em>')
                            // åˆ†å‰²çº¿
        .replace(/^---$/gm, '<hr>')
                    // å¼•ç”¨
                    .replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>')
                    // å›¾ç‰‡ï¼ˆæ·»åŠ æ‡’åŠ è½½å’Œç‚¹å‡»äº‹ä»¶ï¼‰
                    .replace(/!\[([^\]]*)\]\(([^)]+)\)/g, (match, alt, src) => {
                        return `<img src="${src}" alt="${alt}" loading="lazy" onclick="app.openLightbox('${src}')" style="cursor: pointer;">`;
                    })
                    // æ®µè½ï¼ˆç®€å•å¤„ç†ï¼‰
                    .split('\n\n')
                    .map(paragraph => {
                        paragraph = paragraph.trim();
                        if (paragraph && !paragraph.startsWith('<')) {
                            return `<p>${paragraph}</p>`;
                        }
                        return paragraph;
                    })
                    .join('\n');
                
                this.elements.markdownContent.innerHTML = html;
            }

            /**
             * æ•°å­—è½¬ä¸­æ–‡
             * @param {number} num - é˜¿æ‹‰ä¼¯æ•°å­—
             * @returns {string} ä¸­æ–‡æ•°å­—
             */
            numberToChinese(num) {
                const chars = ['', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'ä¸ƒ', 'å…«', 'ä¹', 'å'];
                if (num <= 10) {
                    return chars[num];
                } else if (num < 20) {
                    return 'å' + chars[num - 10];
                } else {
                    return chars[Math.floor(num / 10)] + 'å' + chars[num % 10];
                }
            }

// ç§»åŠ¨ç«¯ä¾§è¾¹æ æ§åˆ¶
toggleMobileSidebar() {
    this.elements.sidebar.classList.toggle('active');
    this.elements.mobileOverlay.classList.toggle('active');
}

closeMobileSidebar() {
    this.elements.sidebar.classList.remove('active');
    this.elements.mobileOverlay.classList.remove('active');
}


            // éŸ³ä¹æ’­æ”¾å™¨æ§åˆ¶
            setupMusicPlayer() {
                // åˆå§‹åŒ–éŸ³é¢‘å…ƒç´ 
                this.elements.audioPlayer.volume = 0.7;
                // è‹¥å…ƒæ•°æ®å·²å°±ç»ªï¼Œæ˜¾ç¤ºæ°”æ³¡
                setTimeout(() => {
                    if (this.elements.audioPlayer.readyState >= 1) {
                        this.showMusicBubble();
                    }
                }, 600);
            }

            // å°æ°”æ³¡ï¼šæ˜¾ç¤ºæ­Œæ›²åï¼Œæ•°ç§’åè‡ªåŠ¨æ”¶èµ·
            showMusicBubble() {
                if (!this.elements.musicBubble) return;
                const title = (window.playlist && window.playlist[0] && window.playlist[0].title) || 'æ­£åœ¨æ’­æ”¾';
                this.elements.musicBubble.textContent = title;
                this.elements.musicBubble.classList.add('active');
                // 2.5ç§’åè‡ªåŠ¨éšè—ï¼ˆè‹¥æœªæ’­æ”¾ä¸”æœªæ‰‹åŠ¨å±•å¼€é¢æ¿ï¼‰
                clearTimeout(this._bubbleTimer);
                this._bubbleTimer = setTimeout(() => {
                    this.hideMusicBubble();
                }, 2500);
            }

            hideMusicBubble() {
                if (!this.elements.musicBubble) return;
                this.elements.musicBubble.classList.remove('active');
            }

            toggleMusicPanel() {
                const isActive = this.elements.musicPanel.classList.contains('active');
                if (isActive) {
                    this.hideMusicPanel();
                } else {
                    this.showMusicPanel();
                }
            }

            showMusicPanel() {
                this.elements.musicPanel.classList.add('active');
            }

            hideMusicPanel() {
                if (!this.showingSongTitle) {
                    this.elements.musicPanel.classList.remove('active');
                }
            }

            togglePlayback() {
                if (this.isPlaying) {
                    this.pauseAudio();
                } else {
                    this.playAudio();
                }
            }

            async playAudio() {
                try {
                    await this.elements.audioPlayer.play();
                    this.isPlaying = true;
                    this.elements.playButton.innerHTML = 'â¸ï¸';
                    this.elements.playButton.setAttribute('aria-label', 'æš‚åœ');
                    this.showMusicPanel();
                } catch (error) {
                    console.error('æ’­æ”¾å¤±è´¥:', error);
                    alert('æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶æ˜¯å¦å¯ç”¨');
                }
            }

            pauseAudio() {
                this.elements.audioPlayer.pause();
                this.isPlaying = false;
                this.elements.playButton.innerHTML = 'â–¶ï¸';
                this.elements.playButton.setAttribute('aria-label', 'æ’­æ”¾');
                
                // æš‚åœå2ç§’è‡ªåŠ¨éšè—é¢æ¿
                setTimeout(() => {
                    if (!this.isPlaying) {
                        this.hideMusicPanel();
                    }
                }, 2000);
            }

            resetPlayer() {
                this.isPlaying = false;
                this.elements.playButton.innerHTML = 'â–¶ï¸';
                this.elements.playButton.setAttribute('aria-label', 'æ’­æ”¾');
                this.elements.progressBar.style.width = '0%';
                this.hideMusicPanel();
            }

            updateProgress() {
                const audio = this.elements.audioPlayer;
                if (audio.duration) {
                    const progress = (audio.currentTime / audio.duration) * 100;
                    this.elements.progressBar.style.width = `${progress}%`;
                }
            }

            seekAudio(event) {
                const rect = this.elements.progressContainer.getBoundingClientRect();
                const clickX = event.clientX - rect.left;
                const width = rect.width;
                const percentage = clickX / width;
                
                const audio = this.elements.audioPlayer;
                if (audio.duration) {
                    audio.currentTime = audio.duration * percentage;
                }
            }

            // å›¾ç‰‡ç¯ç®±æ§åˆ¶
            openLightbox(src) {
                this.elements.lightboxImg.src = src;
                this.elements.lightbox.classList.add('active');
                document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
            }

            closeLightbox() {
                this.elements.lightbox.classList.remove('active');
                document.body.style.overflow = ''; // æ¢å¤æ»šåŠ¨
            }

            /**
             * ä»URL hashåˆå§‹åŒ–ä¿¡ä»¶
             */
            initializeFromHash() {
                const hash = window.location.hash.replace('#', '');
                if (hash && /^\d+$/.test(hash)) {
                    const letterNumber = parseInt(hash);
                    if (letterNumber >= 1 && letterNumber <= this.totalLetters) {
                        this.loadLetterFromNumber(letterNumber);
                        return;
                    }
                }
                // å¦‚æœæ²¡æœ‰æœ‰æ•ˆçš„hashï¼Œé»˜è®¤åŠ è½½ç¬¬3å°ä¿¡
                this.loadLetter('letter3');
            }

            /**
             * å¤„ç†hashå˜åŒ–
             */
            handleHashChange() {
                const hash = window.location.hash.replace('#', '');
                if (hash && /^\d+$/.test(hash)) {
                    const letterNumber = parseInt(hash);
                    if (letterNumber >= 1 && letterNumber <= this.totalLetters) {
                        this.loadLetterFromNumber(letterNumber);
                    }
                }
            }

            /**
             * æ ¹æ®æ•°å­—åŠ è½½ä¿¡ä»¶
             * @param {number} letterNumber - ä¿¡ä»¶ç¼–å·
             */
            loadLetterFromNumber(letterNumber) {
                const letterId = `letter${letterNumber}`;
                const letterItem = document.querySelector(`[data-letter="${letterId}"]`);
                if (letterItem) {
                    this.selectLetter(letterItem, letterId);
                } else {
                    // å¦‚æœæ‰¾ä¸åˆ°å¯¹åº”çš„ä¿¡ä»¶é¡¹ï¼Œç›´æ¥åŠ è½½å†…å®¹
                    this.loadLetter(letterId);
                }
            }
        }

        let app;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            app = new LoveLettersApp();
        });
    </script>
</body>
</html>